
<!DOCTYPE html>
<html lang="en" spellcheck="false">
<head>
  <meta charset="UTF-8">
  <title>Trade Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      line-height: 1.6;
    }
    h1 { 
      color: #2c3e50; 
      margin: 0 0 25px; 
      text-align: center;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    button, label.upload-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 7px 12px;
      margin: 3px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    button:hover, label.upload-btn:hover { 
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input[type="file"] { display: none; }
    .upload-container { text-align: left; margin-bottom: 15px; }
    .upload-status, .upload-error {
      margin: 10px 0; padding: 8px; border-radius: 4px; display: none;
    }
    .upload-status { color: #27ae60; background-color: #f1f8e9; }
    .upload-error { color: #e74c3c; background-color: #fdedeb; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 15px 0; 
    }
    th, td {
      border: 1px solid #eee;
      padding: 8px 5px;
      text-align: center;
      vertical-align: middle;
    }
    th:nth-child(1), td:nth-child(1) { width: 20%; }
    th:nth-child(2), td:nth-child(2) { width: 25%; }
    th:nth-child(3), td:nth-child(3) { width: 20%; }
    th:nth-child(4), td:nth-child(4) { width: 20%; }
    th:nth-child(5), td:nth-child(5) { width: 15%; }
    th {
      background: #3498db;
      color: white;
      font-weight: 600;
      font-size: 13px;
    }
    tr:nth-child(even) td { background-color: #f9f9f9; }
    tr:hover td { background-color: #f1f8ff; }
    .action-btn {
      cursor: pointer; 
      padding: 4px 8px; 
      margin: 0 2px;
      border-radius: 3px; 
      font-size: 12px; 
      transition: all 0.2s;
    }
    .delete-btn { background: #e74c3c; color: white; border: none; }
    .delete-btn:hover { background: #c0392b; transform: translateY(-1px); }
    td[contenteditable="true"] { 
      cursor: text; 
      transition: all 0.2s;
      min-height: 28px;
      line-height: 28px;
      padding: 0 5px;
    }
    td[contenteditable="true"]:focus {
      background-color: #e3f2fd; 
      outline: 2px solid #3498db;
      outline-offset: -1px;
    }
    .action-cell { 
      width: 100%; 
      cursor: pointer; 
      position: relative; 
      min-height: 28px;
      line-height: 28px;
    }
    h2 {
      color: #2c3e50; 
      margin-top: 20px; 
      margin-bottom: 10px;
      font-size: 1.3rem; 
      text-align: left;
      border-bottom: 2px solid #f1f1f1; 
      padding-bottom: 6px;
    }
    .action-options {
      position: absolute; 
      z-index: 100; 
      background: white;
      border: 1px solid #ddd; 
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 3px 0; 
      min-width: 90px; 
      display: none;
      font-size: 13px;
    }
    .action-option {
      padding: 6px 12px; 
      text-align: left; 
      cursor: pointer;
      transition: background 0.2s;
    }
    .action-option:hover { background: #f1f8ff; color: #3498db; }
    #addTradeTable {
      margin-bottom: 10px;
    }
    #addRow td {
      padding: 5px 3px;
    }
    [placeholder]:empty:before {
      content: attr(placeholder);
      color: #999;
      font-style: italic;
    }
    [placeholder]:empty:focus:before {
      content: "";
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Trade Tracker</h1>

    <div class="upload-container">
      <label for="csvFile" class="upload-btn">ğŸ“‚ Import CSV</label>
      <input type="file" id="csvFile" accept=".csv">
      <div class="upload-status" id="uploadStatus"></div>
      <div class="upload-error" id="uploadError"></div>
    </div>

    <h2>â• Add Trade</h2>
    <table id="addTradeTable">
      <thead>
        <tr>
          <th>Action</th><th>Symbol</th><th>Quantity</th><th>Price</th><th>Add</th>
        </tr>
      </thead>
      <tbody>
        <tr id="addRow">
          <td class="action-cell" id="newAction" onclick="showNewActionOptions(this)">Buy</td>
          <td contenteditable="true" id="newSymbol" placeholder="Ticker"></td>
          <td contenteditable="true" id="newQty" placeholder="Shares"></td>
          <td contenteditable="true" id="newPrice" placeholder="Price"></td>
          <td><button onclick="manualAdd()">+</button></td>
        </tr>
      </tbody>
    </table>

    <h2>Transactions</h2>
    <table id="tradeTable">
      <thead>
        <tr>
          <th>Action</th><th>Symbol</th><th>Quantity</th><th>Price</th><th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Summary</h2>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Symbol</th><th>Current Quantity</th><th>Average Price</th><th>Cost Basis</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let trades = [];
    let activeOptions = null;

    function showStatus(msg, err=false) {
      const s = document.getElementById('uploadStatus');
      const e = document.getElementById('uploadError');
      s.style.display = err ? 'none':'block';
      e.style.display = err ? 'block':'none';
      if (err) e.textContent = msg; else s.textContent = msg;
      setTimeout(()=>{s.style.display='none'; e.style.display='none';},3000);
    }

    document.addEventListener('click', e=>{
      if (activeOptions && !activeOptions.contains(e.target) && 
          !e.target.classList.contains('action-cell')) {
        activeOptions.remove(); activeOptions=null;
      }
    });

    document.getElementById('addRow').addEventListener('keypress', function(e){
      if (e.key==='Enter'){ e.preventDefault(); manualAdd(); }
    });

    function showActionOptions(index, cell){
      if (activeOptions) activeOptions.remove();
      const box=document.createElement('div');
      box.className='action-options';
      ["Buy","Sell","Sell Short","Buy to Cover"].forEach(a=>{
        const o=document.createElement('div'); o.className='action-option';
        o.textContent=a; o.onclick=()=>{trades[index].action=a; renderTables(); box.remove(); activeOptions=null;};
        box.appendChild(o);
      });
      const rect=cell.getBoundingClientRect();
      box.style.top=`${rect.bottom+window.scrollY}px`; box.style.left=`${rect.left+window.scrollX}px`;
      document.body.appendChild(box); activeOptions=box; setTimeout(()=>box.style.display='block',10);
    }

    function showNewActionOptions(cell){
      if (activeOptions) activeOptions.remove();
      const box=document.createElement('div'); box.className='action-options';
      ["Buy","Sell","Sell Short","Buy to Cover"].forEach(a=>{
        const o=document.createElement('div'); o.className='action-option';
        o.textContent=a; o.onclick=()=>{cell.textContent=a; box.remove(); activeOptions=null;};
        box.appendChild(o);
      });
      const rect=cell.getBoundingClientRect();
      box.style.top=`${rect.bottom+window.scrollY}px`; box.style.left=`${rect.left+window.scrollX}px`;
      document.body.appendChild(box); activeOptions=box; setTimeout(()=>box.style.display='block',10);
    }

    function normalizeQty(action, qty){
      qty=Number(qty);
      if (action==="Buy"||action==="Buy to Cover") return qty;
      if (action==="Sell"||action==="Sell Short") return -qty;
      return qty;
    }

    function addTrade(action,symbol,qty,price,prepend=false){
      symbol=symbol.replace(/~/g,'').toUpperCase();
      const trade={action,symbol,qty:Number(qty),price:Number(price)};
      if(prepend){trades.unshift(trade);}else{trades.push(trade);}
      renderTables();
    }

    function manualAdd(){
      const action=document.getElementById("newAction").textContent;
      const symbol=document.getElementById("newSymbol").textContent.trim().replace(/~/g,'').toUpperCase();
      const qty=document.getElementById("newQty").textContent;
      const price=document.getElementById("newPrice").textContent;

      if(!symbol||!qty||!price) return;

      addTrade(action,symbol,qty,price,true);

      // åªæ¸…ç©ºæ•°é‡å’Œä»·æ ¼ï¼Œä¿ç•™Symbol
      document.getElementById("newQty").textContent="";
      document.getElementById("newPrice").textContent="";
      // èšç„¦åˆ°æ•°é‡è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿è¿ç»­è¾“å…¥åŒä¸€è‚¡ç¥¨çš„äº¤æ˜“
      document.getElementById("newQty").focus();
    }

    function renderTables(){
      const tbody=document.querySelector("#tradeTable tbody");
      tbody.innerHTML="";
      trades.forEach((t,i)=>{
        const row=document.createElement('tr');
        const ac=document.createElement('td'); ac.className='action-cell'; ac.textContent=t.action;
        ac.onclick=e=>{e.stopPropagation(); showActionOptions(i,ac);};
        const sc=document.createElement('td'); sc.contentEditable=true; sc.textContent=t.symbol;
        sc.onblur=()=>updateTrade(i,'symbol',sc.textContent);
        const qc=document.createElement('td'); qc.contentEditable=true; qc.textContent=t.qty;
        qc.onblur=()=>updateTrade(i,'qty',qc.textContent);
        const pc=document.createElement('td'); pc.contentEditable=true; pc.textContent=t.price;
        pc.onblur=()=>updateTrade(i,'price',pc.textContent);
        const dc=document.createElement('td');
        dc.innerHTML=`<button class="action-btn delete-btn" onclick="deleteTrade(${i})">ğŸ—‘</button>`;
        row.append(ac,sc,qc,pc,dc); tbody.appendChild(row);
      });
      updateSummary();
    }

    function updateSummary(){
      const summary={};
      trades.forEach(t=>{
        const q=normalizeQty(t.action,t.qty);
        if(!summary[t.symbol]) summary[t.symbol]={qty:0,cost:0};
        summary[t.symbol].qty+=q;
        summary[t.symbol].cost+=q*t.price;
      });
      const sbody=document.querySelector("#summaryTable tbody"); sbody.innerHTML="";
      for(let sym in summary){
        const avg=summary[sym].qty!==0?(summary[sym].cost/summary[sym].qty):0;
        const costBasis=avg*summary[sym].qty;
        sbody.innerHTML+=`<tr>
          <td>${sym}</td><td>${summary[sym].qty}</td>
          <td>$${avg.toFixed(2)}</td><td>$${costBasis.toFixed(2)}</td>
        </tr>`;
      }
    }

    function updateTrade(i,f,v){
      if(f==="qty"||f==="price"){
        const num=parseFloat(v); if(isNaN(num)||num<0){renderTables();return;}
        trades[i][f]=num;
      } else if(f==="symbol"){
        trades[i][f]=v.trim().replace(/~/g,'').toUpperCase();
      }
      updateSummary();
    }

    function deleteTrade(i){ trades.splice(i,1); renderTables(); }

    document.getElementById("csvFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        showStatus('è¯·é€‰æ‹©CSVæ ¼å¼çš„æ–‡ä»¶', true);
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(event) {
        try {
          const results = Papa.parse(event.target.result, {
            header: true,
            skipEmptyLines: true
          });
          
          if (results.errors && results.errors.length > 0) {
            showStatus(`CSVè§£æé”™è¯¯: ${results.errors[0].message}`, true);
            return;
          }
          
          if (!results.data || results.data.length === 0) {
            showStatus('CSVæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®', true);
            return;
          }
          
          let importedCount = 0;
          results.data.forEach(row => {
            const action = row.Action || row.action || row.ACTION;
            const symbol = row.Symbol || row.symbol || row.SYMBOL;
            const quantity = row.Quantity || row.quantity || row.QUANTITY;
            const price = row.Price || row.price || row.PRICE;
            
            if (action && symbol && quantity && price) {
              let cleanedPrice = price.toString().replace(/\$/g, "").trim();
              let cleanedSymbol = symbol.replace(/~/g, '').toUpperCase();
              
              addTrade(action, cleanedSymbol, quantity, cleanedPrice);
              importedCount++;
            }
          });
          
          if (importedCount > 0) {
            showStatus(`æˆåŠŸå¯¼å…¥ ${importedCount} æ¡äº¤æ˜“è®°å½•`);
          } else {
            showStatus('æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº¤æ˜“è®°å½•ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼', true);
          }
        } catch (error) {
          showStatus(`å¯¼å…¥å¤±è´¥: ${error.message}`, true);
          console.error('CSVå¯¼å…¥é”™è¯¯:', error);
        }
      };
      
      reader.onerror = function() {
        showStatus('æ— æ³•è¯»å–æ–‡ä»¶ï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶', true);
      };
      
      reader.readAsText(file);
      this.value = '';
    });
  </script>
</body>
</html>
