<!DOCTYPE html>
<html lang="en" spellcheck="false">
<head>
  <meta charset="UTF-8">
  <title>Trade Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      line-height: 1.6;
    }
    h1 { 
      color: #2c3e50;
      margin-bottom: 25px;
      text-align: left;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    #tradeForm {
      text-align: left;
      margin: 20px 0;
    }
    button, label.upload-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 9px 16px;
      margin: 6px 6px 6px 0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    button:hover, label.upload-btn:hover { 
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input {
      padding: 8px 10px;
      margin: 4px 4px 4px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 180px;
      font-size: 14px;
      transition: border 0.2s ease;
    }
    input:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    input[type="file"] { display: none; }
    .upload-container {
      text-align: left;
      margin-bottom: 15px;
    }
    .upload-status {
      color: #27ae60;
      margin: 10px 0;
      padding: 8px;
      background-color: #f1f8e9;
      border-radius: 4px;
      display: none;
    }
    .upload-error {
      color: #e74c3c;
      margin: 10px 0;
      padding: 8px;
      background-color: #fdedeb;
      border-radius: 4px;
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #eee;
      padding: 12px 8px;
      text-align: center;
    }
    th {
      background: #3498db;
      color: white;
      font-weight: 600;
    }
    tr:nth-child(even) td {
      background-color: #f9f9f9;
    }
    tr:hover td {
      background-color: #f1f8ff;
    }
    .action-btn {
      cursor: pointer;
      padding: 5px 10px;
      margin: 0 2px;
      border-radius: 4px;
      font-size: 13px;
      transition: all 0.2s;
    }
    .delete-btn { 
      background: #e74c3c; 
      color: white; 
      border: none;
    }
    .delete-btn:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }
    td[contenteditable="true"] {
      cursor: text;
      transition: all 0.2s;
    }
    td[contenteditable="true"]:focus {
      background-color: #e3f2fd;
      outline: 2px solid #3498db;
    }
    .action-cell {
      width: 120px;
      cursor: pointer;
      position: relative;
    }
    h2 {
      color: #2c3e50;
      margin-top: 25px;
      margin-bottom: 15px;
      font-size: 1.4rem;
      text-align: left;
      border-bottom: 2px solid #f1f1f1;
      padding-bottom: 8px;
    }
    
    /* éšè—å¼é€‰é¡¹æ¡†æ ·å¼ */
    .action-options {
      position: absolute;
      z-index: 100;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      padding: 5px 0;
      min-width: 100px;
      display: none;
    }
    
    .action-option {
      padding: 8px 15px;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .action-option:hover {
      background: #f1f8ff;
      color: #3498db;
    }
    
    /* Add TradeåŒºåŸŸçš„Actioné€‰æ‹©å™¨ */
    #action {
      padding: 8px 10px;
      margin: 4px 4px 4px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 180px;
      font-size: 14px;
      background-color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Trade Tracker</h1>

    <!-- CSV å¯¼å…¥æŒ‰é’® -->
    <div class="upload-container">
      <label for="csvFile" class="upload-btn">ğŸ“‚ Import CSV</label>
      <input type="file" id="csvFile" accept=".csv">
      <div class="upload-status" id="uploadStatus"></div>
      <div class="upload-error" id="uploadError"></div>
    </div>

    <!-- æ‰‹åŠ¨å½•å…¥è¡¨å• -->
    <h2>â• Add Trade</h2>
    <form id="tradeForm" onsubmit="return false;">
      <select id="action">
        <option value="Buy">Buy</option>
        <option value="Sell">Sell</option>
        <option value="Sell Short">Sell Short</option>
        <option value="Buy to Cover">Buy to Cover</option>
      </select>
      <input type="text" id="symbol" placeholder="Ticker Symbol (e.g. QQQ)" required 
             oninput="this.value = this.value.replace(/~/g, '').toUpperCase()">
      <input type="number" id="quantity" placeholder="Shares" required>
      <input type="number" id="price" step="0.01" placeholder="Price per Share" required>
      <button type="button" onclick="manualAdd()">Add</button>
    </form>

    <!-- äº¤æ˜“è¡¨ -->
    <h2>Transactions</h2>
    <table id="tradeTable">
      <thead>
        <tr>
          <th>Action</th>
          <th>Symbol</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- æ±‡æ€»è¡¨ -->
    <h2>Summary</h2>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Current Quantity</th>
          <th>Average Price</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let trades = [];
    let activeOptions = null; 

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, isError = false) {
      const statusEl = document.getElementById('uploadStatus');
      const errorEl = document.getElementById('uploadError');
      
      statusEl.style.display = isError ? 'none' : 'block';
      errorEl.style.display = isError ? 'block' : 'none';
      
      if (isError) {
        errorEl.textContent = message;
      } else {
        statusEl.textContent = message;
      }
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        statusEl.style.display = 'none';
        errorEl.style.display = 'none';
      }, 3000);
    }

    document.addEventListener('click', (e) => {
      if (activeOptions && !activeOptions.contains(e.target) && 
          !e.target.classList.contains('action-cell')) {
        activeOptions.remove();
        activeOptions = null;
      }
    });

    document.getElementById('tradeForm').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        manualAdd();
      }
    });

    function showActionOptions(index, cell) {
      if (activeOptions) {
        activeOptions.remove();
      }

      const optionsBox = document.createElement('div');
      optionsBox.className = 'action-options';
      
      const actions = ["Buy", "Sell", "Sell Short", "Buy to Cover"];
      actions.forEach(action => {
        const option = document.createElement('div');
        option.className = 'action-option';
        option.textContent = action;
        option.onclick = () => {
          trades[index].action = action;
          renderTables();
          optionsBox.remove();
          activeOptions = null;
        };
        optionsBox.appendChild(option);
      });

      const rect = cell.getBoundingClientRect();
      optionsBox.style.top = `${rect.bottom + window.scrollY}px`;
      optionsBox.style.left = `${rect.left + window.scrollX}px`;
      
      document.body.appendChild(optionsBox);
      activeOptions = optionsBox;
      
      setTimeout(() => {
        optionsBox.style.display = 'block';
      }, 10);
    }

    function normalizeQty(action, qty) {
      qty = Number(qty);
      if (action === "Buy" || action === "Buy to Cover") return qty;
      if (action === "Sell" || action === "Sell Short") return -qty;
      return qty;
    }

    function addTrade(action, symbol, qty, price, prepend=false) {
      symbol = symbol.replace(/~/g, '').toUpperCase();
      const trade = { action, symbol, qty: Number(qty), price: Number(price) };
      if (prepend) {
        trades.unshift(trade);
      } else {
        trades.push(trade);
      }
      renderTables();
    }

    function manualAdd() {
      const action = document.getElementById("action").value;
      const symbol = document.getElementById("symbol").value.trim().replace(/~/g, '').toUpperCase();
      const qty = document.getElementById("quantity").value;
      const price = document.getElementById("price").value;

      if (!symbol || !qty || !price) return;

      addTrade(action, symbol, qty, price, true);

      document.getElementById("symbol").value = "";
      document.getElementById("quantity").value = "";
      document.getElementById("price").value = "";
      document.getElementById("symbol").focus();
    }

    function renderTables() {
      const tbody = document.querySelector("#tradeTable tbody");
      tbody.innerHTML = "";
      trades.forEach((t, i) => {
        const row = document.createElement('tr');
        
        const actionCell = document.createElement('td');
        actionCell.className = 'action-cell';
        actionCell.textContent = t.action;
        actionCell.onclick = (e) => {
          e.stopPropagation();
          showActionOptions(i, actionCell);
        };
        
        const symbolCell = document.createElement('td');
        symbolCell.contentEditable = true;
        symbolCell.textContent = t.symbol;
        symbolCell.onblur = () => {
          updateTrade(i, 'symbol', symbolCell.textContent);
        };
        
        const qtyCell = document.createElement('td');
        qtyCell.contentEditable = true;
        qtyCell.textContent = t.qty;
        qtyCell.onblur = () => {
          updateTrade(i, 'qty', qtyCell.textContent);
        };
        
        const priceCell = document.createElement('td');
        priceCell.contentEditable = true;
        priceCell.textContent = t.price;
        priceCell.onblur = () => {
          updateTrade(i, 'price', priceCell.textContent);
        };
        
        const deleteCell = document.createElement('td');
        deleteCell.innerHTML = `<button class="action-btn delete-btn" onclick="deleteTrade(${i})">ğŸ—‘</button>`;
        
        row.appendChild(actionCell);
        row.appendChild(symbolCell);
        row.appendChild(qtyCell);
        row.appendChild(priceCell);
        row.appendChild(deleteCell);
        tbody.appendChild(row);
      });

      updateSummary();
    }

    function updateSummary() {
      const summary = {};
      trades.forEach(t => {
        const q = normalizeQty(t.action, t.qty);
        if (!summary[t.symbol]) summary[t.symbol] = { qty: 0, cost: 0 };
        summary[t.symbol].qty += q;
        summary[t.symbol].cost += q * t.price;
      });

      const sbody = document.querySelector("#summaryTable tbody");
      sbody.innerHTML = "";
      for (let sym in summary) {
        const avg = summary[sym].qty !== 0 ? (summary[sym].cost / summary[sym].qty) : 0;
        sbody.innerHTML += `<tr>
          <td>${sym}</td>
          <td>${summary[sym].qty}</td>
          <td>$${avg.toFixed(2)}</td>
        </tr>`;
      }
    }

    function updateTrade(index, field, value) {
      if (field === "qty" || field === "price") {
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue < 0) {
          alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„${field === "qty" ? "æ•°é‡" : "ä»·æ ¼"}`);
          renderTables();
          return;
        }
        trades[index][field] = numValue;
      } else if (field === "symbol") {
        trades[index][field] = value.trim().replace(/~/g, '').toUpperCase();
      }
      
      updateSummary();
    }

    function deleteTrade(index) {
      trades.splice(index, 1);
      renderTables();
    }

    // ä¿®å¤CSVå¯¼å…¥åŠŸèƒ½
    document.getElementById("csvFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        showStatus('è¯·é€‰æ‹©CSVæ ¼å¼çš„æ–‡ä»¶', true);
        return;
      }
      
      // è¯»å–å¹¶è§£æCSV
      const reader = new FileReader();
      
      reader.onload = function(event) {
        try {
          const results = Papa.parse(event.target.result, {
            header: true,
            skipEmptyLines: true
          });
          
          if (results.errors && results.errors.length > 0) {
            showStatus(`CSVè§£æé”™è¯¯: ${results.errors[0].message}`, true);
            return;
          }
          
          if (!results.data || results.data.length === 0) {
            showStatus('CSVæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®', true);
            return;
          }
          
          let importedCount = 0;
          results.data.forEach(row => {
            // æ›´çµæ´»çš„åˆ—ååŒ¹é…ï¼Œæ”¯æŒä¸åŒå¤§å°å†™å’Œç©ºæ ¼
            const action = row.Action || row.action || row.ACTION;
            const symbol = row.Symbol || row.symbol || row.SYMBOL;
            const quantity = row.Quantity || row.quantity || row.QUANTITY;
            const price = row.Price || row.price || row.PRICE;
            
            if (action && symbol && quantity && price) {
              let cleanedPrice = price.toString().replace(/\$/g, "").trim();
              let cleanedSymbol = symbol.replace(/~/g, '').toUpperCase();
              
              addTrade(action, cleanedSymbol, quantity, cleanedPrice);
              importedCount++;
            }
          });
          
          if (importedCount > 0) {
            showStatus(`æˆåŠŸå¯¼å…¥ ${importedCount} æ¡äº¤æ˜“è®°å½•`);
          } else {
            showStatus('æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº¤æ˜“è®°å½•ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼', true);
          }
        } catch (error) {
          showStatus(`å¯¼å…¥å¤±è´¥: ${error.message}`, true);
          console.error('CSVå¯¼å…¥é”™è¯¯:', error);
        }
      };
      
      reader.onerror = function() {
        showStatus('æ— æ³•è¯»å–æ–‡ä»¶ï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶', true);
      };
      
      // è¯»å–æ–‡ä»¶å†…å®¹
      reader.readAsText(file);
      
      // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
      this.value = '';
    });
  </script>
</body>
</html>
